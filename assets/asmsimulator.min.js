/*! asmsimulator 11-12-2023 */
var app=angular.module("ASMSimulator",[]);app.service("assembler",["opcodes",function(c){return{go:function(d){for(var e=/^[\t ]*(?:([.A-Za-z]\w*)[:])?(?:[\t ]*([A-Za-z]{2,4})(?:[\t ]+(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*)(?:[\t ]*[,][\t ]*(\[(\w+((\+|-)\d+)?)\]|\".+?\"|\'.+?\'|[.A-Za-z0-9]\w*))?)?)?/,f=3,g=7,h=/^[-+]?[0-9]+$/,i=/^[.A-Za-z]\w*$/,j=[],k={},l={},m={},n=d.split("\n"),o=function(a){if("0x"===a.slice(0,2))return parseInt(a.slice(2),16);if("0o"===a.slice(0,2))return parseInt(a.slice(2),8);if("b"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),2);if("d"===a.slice(a.length-1))return parseInt(a.slice(0,a.length-1),10);if(h.exec(a))return parseInt(a,10);throw"Invalid number format"},p=function(a){return a=a.toUpperCase(),"A"===a?0:"B"===a?1:"C"===a?2:"D"===a?3:"SP"===a?4:void 0},q=function(a){a=a.toUpperCase();var b=0,c=0;if("A"===a[0])c=0;else if("B"===a[0])c=1;else if("C"===a[0])c=2;else if("D"===a[0])c=3;else{if("SP"!==a.slice(0,2))return void 0;c=4}var d=1;if(4===c&&(d=2),"-"===a[d])b=-1;else{if("+"!==a[d])return void 0;b=1}var e=b*parseInt(a.slice(d+1),10);if(-16>e||e>15)throw"offset must be a value between -16...+15";return 0>e&&(e=32+e),8*e+c},r=function(a,b,c){var d=p(a);if(void 0!==d)return{type:b,value:d};var e=s(a);if(void 0!==e)return{type:c,value:e};if("regaddress"===b&&(d=q(a),void 0!==d))return{type:b,value:d};var f=o(a);if(isNaN(f))throw"Not a "+c+": "+f;if(0>f||f>65535)throw c+" must have a value between 0-65535";return{type:c,value:f}},s=function(a){return i.exec(a)?a:void 0},t=function(a){switch(a.slice(0,1)){case"[":var b=a.slice(1,a.length-1);return r(b,"regaddress","address");case'"':for(var c=a.slice(1,a.length-1),d=[],e=0,f=c.length;f>e;e++)d.push(c.charCodeAt(e));return{type:"numbers",value:d};case"'":var g=a.slice(1,a.length-1);if(g.length>1)throw"Only one character is allowed. Use String instead";return{type:"number",value:g.charCodeAt(0)};default:return r(a,"register","number")}},u=(function(a){var b=a.toUpperCase();if(b in m)throw"Duplicate label: "+a;if("A"===b||"B"===b||"C"===b||"D"===b)throw"Label contains keyword: "+b;l[a]=j.length}),v=function(a,b){if(void 0!==b)throw a+": too many arguments"},w=function(a){angular.isNumber(a)?j.push(a>>8&255,255&a):j.push(a,0)},x=0,y=n.length;y>x;x++)try{var z=e.exec(n[x]);if(void 0!==z[1]||void 0!==z[2]){if(void 0!==z[1]&&u(z[1]),void 0!==z[2]){var A,B,C,D=z[2].toUpperCase();switch("DB"!==D&&(k[j.length]=x),D){case"DB":if(A=t(z[f]),"number"===A.type)j.push(A.value>>8&255,255&A.value);else if("numbers"===A.type){for(var E=0,F=A.value.length;F>E;E++)j.push(0,A.value[E]);j.push(0,0)}else{if("address"!==A.type)throw console.log(A.type),"DB does not support this operand : "+A.type;j.push(A.value,0)}break;case"HLT":v("HLT",z[f]),C=c.NONE,w(C);break;case"MOV":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.MOV_REG_TO_REG;else if("register"===A.type&&"address"===B.type)C=c.MOV_ADDRESS_TO_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.MOV_REGADDRESS_TO_REG;else if("address"===A.type&&"register"===B.type)C=c.MOV_REG_TO_ADDRESS;else if("regaddress"===A.type&&"register"===B.type)C=c.MOV_REG_TO_REGADDRESS;else if("register"===A.type&&"number"===B.type)C=c.MOV_NUMBER_TO_REG;else if("address"===A.type&&"number"===B.type)C=c.MOV_NUMBER_TO_ADDRESS;else{if("regaddress"!==A.type||"number"!==B.type)throw"MOV does not support this operands";C=c.MOV_NUMBER_TO_REGADDRESS}w(C),w(A.value),w(B.value);break;case"ADD":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.ADD_REG_TO_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.ADD_REGADDRESS_TO_REG;else if("register"===A.type&&"address"===B.type)C=c.ADD_ADDRESS_TO_REG;else{if("register"!==A.type||"number"!==B.type)throw"ADD does not support this operands";C=c.ADD_NUMBER_TO_REG}w(C),w(A.value),w(B.value);break;case"SUB":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.SUB_REG_FROM_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.SUB_REGADDRESS_FROM_REG;else if("register"===A.type&&"address"===B.type)C=c.SUB_ADDRESS_FROM_REG;else{if("register"!==A.type||"number"!==B.type)throw"SUB does not support this operands";C=c.SUB_NUMBER_FROM_REG}w(C),w(A.value),w(B.value);break;case"INC":if(A=t(z[f]),v("INC",z[g]),"register"!==A.type)throw"INC does not support this operand";C=c.INC_REG,j.push(C>>8&255,255&C,A.value>>8&255,255&A.value);break;case"DEC":if(A=t(z[f]),v("DEC",z[g]),"register"!==A.type)throw"DEC does not support this operand";C=c.DEC_REG,j.push(C>>8&255,255&C,A.value>>8&255,255&A.value);break;case"CMP":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.CMP_REG_WITH_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.CMP_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===B.type)C=c.CMP_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==B.type)throw"CMP does not support this operands";C=c.CMP_NUMBER_WITH_REG}w(C),w(A.value),w(B.value);break;case"JMP":if(A=t(z[f]),v("JMP",z[g]),"register"===A.type)C=c.JMP_REGADDRESS;else{if("number"!==A.type)throw"JMP does not support this operands";C=c.JMP_ADDRESS}w(C),w(A.value);break;case"JC":case"JB":case"JNAE":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.JC_REGADDRESS;else{if("number"!==A.type)throw D+" does not support this operand";C=c.JC_ADDRESS}w(C),w(A.value);break;case"JNC":case"JNB":case"JAE":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.JNC_REGADDRESS;else{if("number"!==A.type)throw D+"does not support this operand";C=c.JNC_ADDRESS}w(C),w(A.value);break;case"JZ":case"JE":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.JZ_REGADDRESS;else{if("number"!==A.type)throw D+" does not support this operand";C=c.JZ_ADDRESS}w(C),w(A.value);break;case"JNZ":case"JNE":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.JNZ_REGADDRESS;else{if("number"!==A.type)throw D+" does not support this operand";C=c.JNZ_ADDRESS}w(C),w(A.value);break;case"JA":case"JNBE":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.JA_REGADDRESS;else{if("number"!==A.type)throw D+" does not support this operand";C=c.JA_ADDRESS}w(C),w(A.value);break;case"JNA":case"JBE":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.JNA_REGADDRESS;else{if("number"!==A.type)throw D+" does not support this operand";C=c.JNA_ADDRESS}w(C),w(A.value);break;case"PUSH":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.PUSH_REG;else if("regaddress"===A.type)C=c.PUSH_REGADDRESS;else if("address"===A.type)C=c.PUSH_ADDRESS;else{if("number"!==A.type)throw"PUSH does not support this operand";C=c.PUSH_NUMBER}w(C),w(A.value);break;case"POP":if(A=t(z[f]),v(D,z[g]),"register"!==A.type)throw"PUSH does not support this operand";C=c.POP_REG,j.push(C>>8&255,255&C,A.value>>8&255,255&A.value);break;case"CALL":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.CALL_REGADDRESS;else{if("number"!==A.type)throw"CALL does not support this operand";C=c.CALL_ADDRESS}w(C),w(A.value);break;case"RET":v(D,z[f]),C=c.RET,w(C);break;case"MUL":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.MUL_REG;else if("regaddress"===A.type)C=c.MUL_REGADDRESS;else if("address"===A.type)C=c.MUL_ADDRESS;else{if("number"!==A.type)throw"MULL does not support this operand";C=c.MUL_NUMBER}w(C),w(A.value);break;case"DIV":if(A=t(z[f]),v(D,z[g]),"register"===A.type)C=c.DIV_REG;else if("regaddress"===A.type)C=c.DIV_REGADDRESS;else if("address"===A.type)C=c.DIV_ADDRESS;else{if("number"!==A.type)throw"DIV does not support this operand";C=c.DIV_NUMBER}w(C),w(A.value);break;case"AND":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.AND_REG_WITH_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.AND_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===B.type)C=c.AND_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==B.type)throw"AND does not support this operands";C=c.AND_NUMBER_WITH_REG}w(C),w(A.value),w(B.value);break;case"OR":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.OR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.OR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===B.type)C=c.OR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==B.type)throw"OR does not support this operands";C=c.OR_NUMBER_WITH_REG}w(C),w(A.value),w(B.value);break;case"XOR":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.XOR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.XOR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===B.type)C=c.XOR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==B.type)throw"XOR does not support this operands";C=c.XOR_NUMBER_WITH_REG}w(C),w(A.value),w(B.value);break;case"NOT":if(A=t(z[f]),v(D,z[g]),"register"!==A.type)throw"NOT does not support this operand";C=c.NOT_REG,w(C),w(A.value);break;case"SHL":case"SAL":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.SHL_REG_WITH_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.SHL_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===B.type)C=c.SHL_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==B.type)throw D+" does not support this operands";C=c.SHL_NUMBER_WITH_REG}w(C),w(A.value),w(B.value);break;case"SHR":case"SAR":if(A=t(z[f]),B=t(z[g]),"register"===A.type&&"register"===B.type)C=c.SHR_REG_WITH_REG;else if("register"===A.type&&"regaddress"===B.type)C=c.SHR_REGADDRESS_WITH_REG;else if("register"===A.type&&"address"===B.type)C=c.SHR_ADDRESS_WITH_REG;else{if("register"!==A.type||"number"!==B.type)throw D+" does not support this operands";C=c.SHR_NUMBER_WITH_REG}w(C),w(A.value),w(B.value);break;default:throw"Invalid instruction: "+z[2]}}}else{var G=n[x].trim();if(""!==G&&";"!==G.slice(0,1))throw"Syntax error"}}catch(H){throw{error:H,line:x}}for(x=0;x<l.size;x++);for(x=0,y=j.length;y>x;x++)if(!angular.isNumber(j[x])){if(!(j[x]in l))throw{error:"Undefined label: "+j[x]};a=x,b=x+1,lab=l[j[x]],j[x]=lab>>8&255,j[++x]=255&lab}return{code:j,mapping:k,labels:l}}}}]),app.service("cpu",["opcodes","memory",function(a,b){var c={step:function(){var c=this;if(c.fault===!0)throw"FAULT. Reset to continue.";try{var d=function(a){if(0>a||a>=c.gpr.length)throw"Invalid register: "+a;return a},e=function(a){if(0>a||a>=1+c.gpr.length)throw"Invalid register: "+a;return a},f=function(a,b){if(a>=0&&a<c.gpr.length)c.gpr[a]=b;else{if(a!=c.gpr.length)throw"Invalid register: "+a;if(c.sp=b,c.sp<c.minSP)throw"Stack overflow";if(c.sp>c.maxSP)throw"Stack underflow"}},g=function(a){if(a>=0&&a<c.gpr.length)return c.gpr[a];if(a==c.gpr.length)return c.sp;throw"Invalid register: "+a},h=function(a){var b,d=a%8;b=d<c.gpr.length?c.gpr[d]:c.sp;var e=Math.floor(a/8);return e>15&&(e-=32),b+e},i=function(a){return c.zero=!1,c.carry=!1,a>=65536?(c.carry=!0,a%=65536):0===a?c.zero=!0:0>a&&(c.carry=!0,a=65536- -a%65536),a},j=function(a){if(0>a||a>=b.data.length)throw"IP outside memory";c.ip=a},k=function(a){if(c.sp-=2,b.store16(c.sp,a),c.sp<c.minSP)throw"Stack overflow";console.log("value_push : "+a+"\n")},l=function(){var a=b.load16(c.sp);if(c.sp+=2,c.sp>c.maxSP)throw"Stack underflow";return console.log("value_pop : "+a),a},m=function(a){if(0===a)throw"Division by 0";return Math.floor(c.gpr[0]/a)};if(c.ip<0||c.ip>=b.data.length)throw"Instruction pointer is outside of memory";var n,o,p,q,r,s=b.load16(c.ip);switch(c.ip++,s){case a.NONE:return!1;case a.MOV_REG_TO_REG:n=e(b.load16(++c.ip)),c.ip++,o=e(b.load16(++c.ip)),c.ip++,f(n,g(o)),c.ip++;break;case a.MOV_ADDRESS_TO_REG:n=e(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,f(n,b.load16(p)),c.ip++;break;case a.MOV_REGADDRESS_TO_REG:n=e(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,f(n,b.load16(h(o))),c.ip++;break;case a.MOV_REG_TO_ADDRESS:q=b.load16(++c.ip),c.ip++,o=e(b.load16(++c.ip)),c.ip++,b.store16(q,g(o)),c.ip++;break;case a.MOV_REG_TO_REGADDRESS:n=b.load16(++c.ip),c.ip++,o=e(b.load16(++c.ip)),c.ip++,b.store16(h(n),g(o)),c.ip++;break;case a.MOV_NUMBER_TO_REG:n=e(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,f(n,r),c.ip++;break;case a.MOV_NUMBER_TO_ADDRESS:q=b.load16(++c.ip),c.ip++,r=b.load16(++c.ip),c.ip++,b.store16(q,r),c.ip++;break;case a.MOV_NUMBER_TO_REGADDRESS:n=b.load16(++c.ip),c.ip++,r=b.load16(++c.ip),c.ip++,b.store16(h(n),r),c.ip++;break;case a.ADD_REG_TO_REG:n=e(b.load16(++c.ip)),c.ip++,o=e(b.load16(++c.ip)),c.ip++,f(n,i(g(n)+g(o))),c.ip++;break;case a.ADD_REGADDRESS_TO_REG:n=e(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,f(n,i(g(n)+b.load16(h(o)))),c.ip++;break;case a.ADD_ADDRESS_TO_REG:n=e(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,f(n,i(g(n)+b.load16(p))),c.ip++;break;case a.ADD_NUMBER_TO_REG:n=e(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,f(n,i(g(n)+r)),c.ip++;break;case a.SUB_REG_FROM_REG:n=e(b.load16(++c.ip)),c.ip++,o=e(b.load16(++c.ip)),c.ip++,f(n,i(g(n)-c.gpr[o])),c.ip++;break;case a.SUB_REGADDRESS_FROM_REG:n=e(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,f(n,i(g(n)-b.load16(h(o)))),c.ip++;break;case a.SUB_ADDRESS_FROM_REG:n=e(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,f(n,i(g(n)-b.load16(p))),c.ip++;break;case a.SUB_NUMBER_FROM_REG:n=e(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,f(n,i(g(n)-r)),c.ip++;break;case a.INC_REG:n=e(b.load16(++c.ip)),c.ip++,f(n,i(g(n)+1)),c.ip++;break;case a.DEC_REG:n=e(b.load16(++c.ip)),c.ip++,f(n,i(g(n)-1)),c.ip++;break;case a.CMP_REG_WITH_REG:n=e(b.load16(++c.ip)),c.ip++,o=e(b.load16(++c.ip)),c.ip++,i(g(n)-g(o)),c.ip++;break;case a.CMP_REGADDRESS_WITH_REG:n=e(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,i(g(n)-b.load16(h(o))),c.ip++;break;case a.CMP_ADDRESS_WITH_REG:n=e(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,i(g(n)-b.load16(p)),c.ip++;break;case a.CMP_NUMBER_WITH_REG:n=e(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,i(g(n)-r),c.ip++;break;case a.JMP_REGADDRESS:n=d(b.load16(++c.ip)),c.ip++,j(c.gpr[n]);break;case a.JMP_ADDRESS:r=b.load16(++c.ip),c.ip++,j(r);break;case a.JC_REGADDRESS:n=d(b.load16(++c.ip)),c.ip++,c.carry?j(c.gpr[n]):c.ip++;break;case a.JC_ADDRESS:r=b.load16(++c.ip),c.ip++,c.carry?j(r):c.ip++;break;case a.JNC_REGADDRESS:n=d(b.load16(++c.ip)),c.ip++,c.carry?c.ip++:j(c.gpr[n]);break;case a.JNC_ADDRESS:r=b.load16(++c.ip),c.ip++,c.carry?c.ip++:j(r);break;case a.JZ_REGADDRESS:n=d(b.load16(++c.ip)),c.ip++,c.zero?j(c.gpr[n]):c.ip++;break;case a.JZ_ADDRESS:r=b.load16(++c.ip),c.ip++,c.zero?j(r):c.ip++;break;case a.JNZ_REGADDRESS:n=d(b.load16(++c.ip)),c.ip++,c.zero?c.ip++:j(c.gpr[n]);break;case a.JNZ_ADDRESS:r=b.load16(++c.ip),c.ip++,c.zero?c.ip++:j(r);break;case a.JA_REGADDRESS:n=d(b.load16(++c.ip)),c.ip++,c.zero||c.carry?c.ip++:j(c.gpr[n]);break;case a.JA_ADDRESS:r=b.load16(++c.ip),c.ip++,c.zero||c.carry?c.ip++:j(r);break;case a.JNA_REGADDRESS:n=d(b.load16(++c.ip)),c.ip++,c.zero||c.carry?j(c.gpr[n]):c.ip++;break;case a.JNA_ADDRESS:r=b.load16(++c.ip),c.ip++,c.zero||c.carry?j(r):c.ip++;break;case a.PUSH_REG:o=d(b.load16(++c.ip)),c.ip++,k(c.gpr[o]),c.ip++;break;case a.PUSH_REGADDRESS:o=b.load16(++c.ip),c.ip++,k(b.load16(h(o))),c.ip++;break;case a.PUSH_ADDRESS:p=b.load16(++c.ip),c.ip++,k(b.load16(p)),c.ip++;break;case a.PUSH_NUMBER:r=b.load16(++c.ip),c.ip++,k(r),c.ip++;break;case a.POP_REG:n=d(b.load16(++c.ip)),c.ip++,c.gpr[n]=l(),c.ip++;break;case a.CALL_REGADDRESS:n=d(b.load16(++c.ip)),k(c.ip+2),j(c.gpr[n]);break;case a.CALL_ADDRESS:console.log("Calling function"),r=b.load16(++c.ip),k(c.ip+2),j(r);break;case a.RET:jump_addr=l(),console.log("jump_addr "+jump_addr),j(jump_addr);break;case a.MUL_REG:o=d(b.load16(++c.ip)),c.ip++,c.gpr[0]=i(c.gpr[0]*c.gpr[o]),c.ip++;break;case a.MUL_REGADDRESS:o=b.load16(++c.ip),c.ip++,c.gpr[0]=i(c.gpr[0]*b.load16(h(o))),c.ip++;break;case a.MUL_ADDRESS:p=b.load16(++c.ip),c.ip++,c.gpr[0]=i(c.gpr[0]*b.load16(p)),c.ip++;break;case a.MUL_NUMBER:r=b.load16(++c.ip),c.ip++,c.gpr[0]=i(c.gpr[0]*r),c.ip++;break;case a.DIV_REG:o=d(b.load16(++c.ip)),c.ip++,c.gpr[0]=i(m(c.gpr[o])),c.ip++;break;case a.DIV_REGADDRESS:o=b.load16(++c.ip),c.ip++,c.gpr[0]=i(m(b.load16(h(o)))),c.ip++;break;case a.DIV_ADDRESS:p=b.load16(++c.ip),c.ip++,c.gpr[0]=i(m(b.load16(p))),c.ip++;break;case a.DIV_NUMBER:r=b.load16(++c.ip),c.ip++,c.gpr[0]=i(m(r)),c.ip++;break;case a.AND_REG_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=d(b.load16(++c.ip)),c.ip++,c.gpr[n]=i(c.gpr[n]&c.gpr[o]),c.ip++;break;case a.AND_REGADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]&b.load16(h(o))),c.ip++;break;case a.AND_ADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]&b.load16(p)),c.ip++;break;case a.AND_NUMBER_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]&r),c.ip++;break;case a.OR_REG_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=d(b.load16(++c.ip)),c.ip++,c.gpr[n]=i(c.gpr[n]|c.gpr[o]),c.ip++;break;case a.OR_REGADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]|b.load16(h(o))),c.ip++;break;case a.OR_ADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]|b.load16(p)),c.ip++;break;case a.OR_NUMBER_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]|r),c.ip++;break;case a.XOR_REG_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=d(b.load16(++c.ip)),c.ip++,c.gpr[n]=i(c.gpr[n]^c.gpr[o]),c.ip++;break;case a.XOR_REGADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]^b.load16(h(o))),c.ip++;break;case a.XOR_ADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]^b.load16(p)),c.ip++;break;case a.XOR_NUMBER_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]^r),c.ip++;break;case a.NOT_REG:n=d(b.load16(++c.ip)),c.ip++,c.gpr[n]=i(~c.gpr[n]),c.ip++;break;case a.SHL_REG_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=d(b.load16(++c.ip)),c.ip++,c.gpr[n]=i(c.gpr[n]<<c.gpr[o]),c.ip++;break;case a.SHL_REGADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]<<b.load16(h(o))),c.ip++;break;case a.SHL_ADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]<<b.load16(p)),c.ip++;break;case a.SHL_NUMBER_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]<<r),c.ip++;break;case a.SHR_REG_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=d(b.load16(++c.ip)),c.ip++,c.gpr[n]=i(c.gpr[n]>>>c.gpr[o]),c.ip++;break;case a.SHR_REGADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,o=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]>>>b.load16(h(o))),c.ip++;break;case a.SHR_ADDRESS_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,p=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]>>>b.load16(p)),c.ip++;break;case a.SHR_NUMBER_WITH_REG:n=d(b.load16(++c.ip)),c.ip++,r=b.load16(++c.ip),c.ip++,c.gpr[n]=i(c.gpr[n]>>>r),c.ip++;break;default:throw"Invalid op code: "+s}return!0}catch(t){throw c.fault=!0,t}},reset:function(){var a=this;a.maxSP=924,a.minSP=0,a.gpr=[0,0,0,0],a.sp=a.maxSP,a.ip=0,a.zero=!1,a.carry=!1,a.fault=!1}};return c.reset(),c}]),app.service("memory",[function(){var a={data:Array(1024),lastAccess:-1,load:function(a){var b=this;if(0>a||a>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,b.data[a]},load16:function(a){var b=this;if(0>a||a+1>=b.data.length)throw"Memory access violation at "+a;return b.lastAccess=a,(b.data[a]<<8)+b.data[a+1]},store:function(a,b){var c=this;if(0>a||a>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b},store16:function(a,b){var c=this;if(0>a||a+1>=c.data.length)throw"Memory access violation at "+a;c.lastAccess=a,c.data[a]=b>>8&255,c.data[a+1]=255&b},reset:function(){var a=this;a.lastAccess=-1;for(var b=0,c=a.data.length;c>b;b++)a.data[b]=0}};return a.reset(),a}]),app.service("opcodes",[function(){var a={NONE:0,MOV_REG_TO_REG:1,MOV_ADDRESS_TO_REG:2,MOV_REGADDRESS_TO_REG:3,MOV_REG_TO_ADDRESS:4,MOV_REG_TO_REGADDRESS:5,MOV_NUMBER_TO_REG:6,MOV_NUMBER_TO_ADDRESS:7,MOV_NUMBER_TO_REGADDRESS:8,ADD_REG_TO_REG:10,ADD_REGADDRESS_TO_REG:11,ADD_ADDRESS_TO_REG:12,ADD_NUMBER_TO_REG:13,SUB_REG_FROM_REG:14,SUB_REGADDRESS_FROM_REG:15,SUB_ADDRESS_FROM_REG:16,SUB_NUMBER_FROM_REG:17,INC_REG:18,DEC_REG:19,CMP_REG_WITH_REG:20,CMP_REGADDRESS_WITH_REG:21,CMP_ADDRESS_WITH_REG:22,CMP_NUMBER_WITH_REG:23,JMP_REGADDRESS:30,JMP_ADDRESS:31,JC_REGADDRESS:32,JC_ADDRESS:33,JNC_REGADDRESS:34,JNC_ADDRESS:35,JZ_REGADDRESS:36,JZ_ADDRESS:37,JNZ_REGADDRESS:38,JNZ_ADDRESS:39,JA_REGADDRESS:40,JA_ADDRESS:41,JNA_REGADDRESS:42,JNA_ADDRESS:43,PUSH_REG:50,PUSH_REGADDRESS:51,PUSH_ADDRESS:52,PUSH_NUMBER:53,POP_REG:54,CALL_REGADDRESS:55,CALL_ADDRESS:56,RET:57,MUL_REG:60,MUL_REGADDRESS:61,MUL_ADDRESS:62,MUL_NUMBER:63,DIV_REG:64,DIV_REGADDRESS:65,DIV_ADDRESS:66,DIV_NUMBER:67,AND_REG_WITH_REG:70,AND_REGADDRESS_WITH_REG:71,AND_ADDRESS_WITH_REG:72,AND_NUMBER_WITH_REG:73,OR_REG_WITH_REG:74,OR_REGADDRESS_WITH_REG:75,OR_ADDRESS_WITH_REG:76,OR_NUMBER_WITH_REG:77,XOR_REG_WITH_REG:78,XOR_REGADDRESS_WITH_REG:79,XOR_ADDRESS_WITH_REG:80,XOR_NUMBER_WITH_REG:81,NOT_REG:82,SHL_REG_WITH_REG:90,SHL_REGADDRESS_WITH_REG:91,SHL_ADDRESS_WITH_REG:92,SHL_NUMBER_WITH_REG:93,SHR_REG_WITH_REG:94,SHR_REGADDRESS_WITH_REG:95,SHR_ADDRESS_WITH_REG:96,SHR_NUMBER_WITH_REG:97};return a}]),app.controller("Ctrl",["$document","$scope","$timeout","cpu","memory","assembler",function(a,b,c,d,e,f){b.memory=e,b.cpu=d,b.error="",b.isRunning=!1,b.displayHex=!0,b.displayInstr=!0,b.displayA=!1,b.displayB=!1,b.displayC=!1,b.displayD=!1,b.speeds=[{speed:1,desc:"1 HZ"},{speed:4,desc:"4 HZ"},{speed:8,desc:"8 HZ"},{speed:16,desc:"16 HZ"}],b.speed=4,b.outputStartIndex=925,b.code='; Simple example\n; Writes Hello World to the output\n\n	JMP start\nhello: DB "Hello World!" ; Variable\n       DB 0	; String terminator\n\nstart:\n	MOV C, hello    ; Point to var \n	MOV D, 925	; Point to output\n	CALL print\n        HLT             ; Stop execution\n\nprint:			; print(C:*from, D:*to)\n	PUSH A\n	PUSH B\n	MOV B, 0\n.loop:\n	MOV A, [C]	; Get char from var\n	MOV [D], A	; Write to output\n	INC C\n	INC D\n	INC C\n	INC D\n	CMP B, [C]	; Check if end\n	JNZ .loop	; jump if not\n\n	POP B\n	POP A\n	RET',b.reset=function(){d.reset(),e.reset(),b.error="",b.selectedLine=-1},b.executeStep=function(){b.checkPrgrmLoaded()||b.assemble();try{var a=d.step();return d.ip in b.mapping&&(b.selectedLine=b.mapping[d.ip]),a}catch(c){return b.error=c,!1}};var g;b.run=function(){b.checkPrgrmLoaded()||b.assemble(),b.isRunning=!0,g=c(function(){b.executeStep()===!0?b.run():b.isRunning=!1},1e3/b.speed)},b.stop=function(){c.cancel(g),b.isRunning=!1},b.checkPrgrmLoaded=function(){for(var a=0,b=e.data.length;b>a;a++)if(0!==e.data[a])return!0;return!1},b.getChar=function(a){var b=String.fromCharCode(a);return""===b.trim()?"  ":b},b.assemble=function(){try{b.reset();var a=f.go(b.code);b.mapping=a.mapping;var c=a.code;if(b.labels=a.labels,c.length>e.data.length)throw"Binary code does not fit into the memory. Max "+e.data.length+" bytes are allowed";for(var d=0,g=c.length;g>d;d++)e.data[d]=c[d]}catch(h){void 0!==h.line?(b.error=h.line+" | "+h.error,b.selectedLine=h.line):b.error=h.error}},b.jumpToLine=function(c){a[0].getElementById("sourceCode").scrollIntoView(),b.selectedLine=b.mapping[c]},b.isInstruction=function(a){return void 0!==b.mapping&&void 0!==b.mapping[a]&&b.displayInstr},b.getMemoryCellCss=function(a){return a>=b.outputStartIndex?"output-bg":b.isInstruction(a)?"instr-bg":a>d.sp&&a<=d.maxSP?"stack-bg":""},b.getMemoryInnerCellCss=function(a){return a===d.ip?"marker marker-ip":a===d.sp?"marker marker-sp":a===d.gpr[0]&&b.displayA?"marker marker-a":a===d.gpr[1]&&b.displayB?"marker marker-b":a===d.gpr[2]&&b.displayC?"marker marker-c":a===d.gpr[3]&&b.displayD?"marker marker-d":""}}]),app.filter("flag",function(){return function(a){return a.toString().toUpperCase()}}),app.filter("number",function(){return function(a,b){if(b){var c=a.toString(16).toUpperCase();return 1==c.length?"0"+c:c}return a.toString(10)}}),app.directive("selectLine",[function(){return{restrict:"A",link:function(a,b,c,d){a.$watch("selectedLine",function(){if(a.selectedLine>=0){for(var c=b[0].value.split("\n"),d=0,e=0;e<c.length&&e!=a.selectedLine;e++)d+=c[e].length+1;var f=c[a.selectedLine].length+d;if("undefined"!=typeof b[0].selectionStart&&(b[0].focus(),b[0].selectionStart=d,b[0].selectionEnd=f),document.selection&&document.selection.createRange){b[0].focus(),b[0].select();var g=document.selection.createRange();g.collapse(!0),g.moveEnd("character",f),g.moveStart("character",d),g.select()}}})}}}]),app.filter("startFrom",function(){return function(a,b){return b=+b,a.slice(b)}}),app.directive("tabSupport",[function(){return{restrict:"A",link:function(a,b,c,d){b.bind("keydown",function(a){if(9===a.keyCode){var b=this.value,c=this.selectionStart,d=this.selectionEnd;return this.value=b.substring(0,c)+"	"+b.substring(d),this.selectionStart=this.selectionEnd=c+1,a.preventDefault(),!1}})}}}]);